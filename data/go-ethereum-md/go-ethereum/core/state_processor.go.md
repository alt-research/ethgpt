# StateProcessor

The `StateProcessor` is a basic processor that takes care of transitioning state from one point to another. It implements the `Processor` interface. It processes the state changes according to the Ethereum rules by running the transaction messages using the `statedb` and applying any rewards to both the processor (coinbase) and any included uncles.

## Type `StateProcessor`

### Function `NewStateProcessor`

`NewStateProcessor` initializes a new `StateProcessor`.

```go
func NewStateProcessor(config *params.ChainConfig, bc *BlockChain, engine consensus.Engine) *StateProcessor
```

##### Parameters

- `config` - Chain configuration options.
- `bc` - Canonical block chain.
- `engine` - Consensus engine used for block rewards.

##### Return Values

- `*StateProcessor` - a new `StateProcessor`.

### Function `Process`

`Process` processes the state changes according to the Ethereum rules by running the transaction messages using the `statedb` and applying any rewards to both the processor (coinbase) and any included uncles. It returns the receipts and logs accumulated during the process and returns the amount of gas that was used in the process. If any of the transactions failed to execute due to insufficient gas it will return an error.

```go
func (p *StateProcessor) Process(block *types.Block, statedb *state.StateDB, cfg vm.Config) (types.Receipts, []*types.Log, uint64, error)
```

##### Parameters

- `block` - The block to process.
- `statedb` - The state database.
- `cfg` - The virtual machine configuration.

##### Return Values

- `types.Receipts` - The receipts accumulated during the process.
- `[]*types.Log` - The logs accumulated during the process.
- `uint64` - The amount of gas used in the process.
- `error` - An error, if any.

## Example

```go
import (
	"github.com/ethereum/go-ethereum/core"
	"github.com/ethereum/go-ethereum/core/state"
	"github.com/ethereum/go-ethereum/core/types"
	"github.com/ethereum/go-ethereum/core/vm"
	"github.com/ethereum/go-ethereum/params"
)

func main() {
	config := params.ChainConfig{}
	bc := &core.BlockChain{}
	engine := &consensus.Engine{}
	processor := core.NewStateProcessor(&config, bc, engine)
	block := &types.Block{}
	statedb := &state.StateDB{}
	cfg := vm.Config{}
	receipts, logs, gasUsed, err := processor.Process(block, statedb, cfg)
	if err != nil {
		// Handle error
	}
	// Use receipts, logs, and gasUsed
}
``` ## Function `applyTransaction`

The `applyTransaction` function applies a transaction to the current state and returns the receipt for the transaction, gas used, and an error if the transaction failed.

### Parameters

- `msg` - a message containing the transaction data.
- `config` - the chain configuration.
- `gp` - the gas pool.
- `statedb` - the state database.
- `blockNumber` - the block number.
- `blockHash` - the block hash.
- `tx` - the transaction to apply.
- `usedGas` - the amount of gas used.
- `evm` - the Ethereum Virtual Machine.

### Return Values

- `*types.Receipt` - the receipt for the transaction.
- `error` - an error, if any.

### Function `ApplyTransaction`

The `ApplyTransaction` function attempts to apply a transaction to the given state database and uses the input parameters for its environment. It returns the receipt for the transaction, gas used, and an error if the transaction failed, indicating the block was invalid.

### Parameters

- `config` - the chain configuration.
- `bc` - the chain context.
- `author` - the address of the author.
- `gp` - the gas pool.
- `statedb` - the state database.
- `header` - the header of the block.
- `tx` - the transaction to apply.
- `usedGas` - the amount of gas used.
- `cfg` - the configuration of the Ethereum Virtual Machine.

### Return Values

- `*types.Receipt` - the receipt for the transaction.
- `error` - an error, if any.

## Function `finalizeAndAssembleBlock`

The `finalizeAndAssembleBlock` function finalizes the block, applying any consensus engine specific extras (e.g. block rewards), and returns the receipts, all logs, used gas, and an error if there is any.

### Parameters

- `p` - the protocol.
- `header` - the header of the block.
- `statedb` - the state database.
- `block` - the block to finalize.

### Return Values

- `types.Receipts` - the receipts for the transactions in the block.
- `types.Logs` - all logs generated by the transactions in the block.
- `uint64` - the amount of gas used by the transactions in the block.
- `error` - an error, if any.